
import sys, os
import re, csv

from yaswfp import swfparser

MALWARE_FOLDER  = '\\malware\\'
NORMAL_FOLDER   = '\\normal\\'

TAGS_FILE       = 'tags.txt'
PARAMETERS_FILE = 'parameters.csv'
LABELS_FILE     = 'labels.csv'

KEY_WORDS = ['ActionScript3',
             'ExternalInterface',
             'hexToBin',
             'ToURL',
             'loadBytes']

tags = []

def getTagsFromFile(filename):
    with open(filename) as file:
        filelines = [row.strip() for row in file]
    return filelines

def getSignatureNumber(signature):
    if(signature == 'CWS'):
        return 0
    if(signature == 'FWS'):
        return 1
    if(signature == 'ZWS'):
        return 2
    return 3

def getHeaderParameters(header):

    parameters = [0] * 8

    parameters[0] = header.FileLength
    parameters[1] = header.FrameCount
    parameters[2] = header.FrameRate

    try:
        parameters[3] = header.FrameSize[0]
        parameters[4] = header.FrameSize[1]
        parameters[5] = header.FrameSize[2]
        parameters[6] = header.FrameSize[3]
    except:
        pass

    if parameters[3] < 0:
        parameters[3] = 0
    if parameters[4] < 0:
        parameters[4] = 0
    if parameters[5] < 0:
        parameters[5] = 0
    if parameters[6] < 0:
        parameters[6] = 0

    parameters[7] = getSignatureNumber(header.Signature)

    return parameters

def getBodyParameters(parser_tags):

    global tags
    parameters = []

    tagsCount = [0] * len(tags)
    numberOfIframes = 0
    numberOfUrls = 0
    keyWordsCount = [0] * len(KEY_WORDS)

    for tag in parser_tags:

        try:
            index = tags.index(tag.name)
            tagsCount[index] += 1
        except:
            pass

        # counting number of the each key word
        for i in range(0, len(KEY_WORDS)):
            if KEY_WORDS[i] in str(tag):
                keyWordsCount[i] += 1

        urls = re.findall(r'http?://(?:[-\w.]|(?:%[\da-fA-F]{2}))+', str(tag))
        numberOfUrls += len(urls)

        iframes = re.findall(r'<iframe src=', str(tag))
        numberOfIframes += len(iframes)

    parameters.append(numberOfIframes)
    parameters.append(numberOfUrls)

    parameters += keyWordsCount
    parameters += tagsCount

    return parameters

def parseFile(filename, isMalware):

    try:
        parser = swfparser.parsefile(filename)
    except:
        print('[-] Can not parse the file')
        return

    parameters = getHeaderParameters(parser.header)
    print(parameters)
    parameters += getBodyParameters(parser.tags)

    with open(PARAMETERS_FILE, "a", newline = "") as file:
        writer = csv.writer(file)
        writer.writerow(parameters)

    with open(LABELS_FILE , "a", newline = "") as file:
        writer = csv.writer(file)
        writer.writerow([isMalware])

    return

def getFileList(directoryName):
    filenames = [os.path.join(directoryName, file)
                 for file in os.listdir(directoryName)]
    return filenames

def main():
    global tags

    tags = getTagsFromFile(os.getcwd() + '\\' + TAGS_FILE)

    #"""
    filenames = getFileList(os.getcwd() + NORMAL_FOLDER)
    for i in range(0, len(filenames)):
        print('[*] Parsing of file (' + str(i) + ')', filenames[i])
        parseFile(filenames[i], 0)
        print('[+] File was successfully completed')
    #"""

    filenames = getFileList(os.getcwd() + MALWARE_FOLDER)
    for i in range(0, len(filenames)):
        print('[*] Parsing of file (' + str(i) + ')', filenames[i])
        parseFile(filenames[i], 1)
        print('[+] File was successfully completed')

if __name__ == "__main__":
    main()
